@model List<LP.Models.ViewModels.DomainVM> 

@{
    var rounds = Model.Select(vm => vm.Round).Distinct().OrderByDescending(r => r);
}


<div class="container-md">
    <button class="btn btn-danger my-4 Admin-only-Containers d-none" id="addDomainButton">Add Domain</button>
    @foreach (var round in rounds)
    {
        <h2>Round @round</h2>
        <table class="table table-bordered table-responsive-md">
            <thead>
                <tr>
                    <th class="table-danger">Id</th>
                    <th class="table-danger">Title</th>
                    <th class="table-danger">Name</th>
                    <th class="table-danger">IpAddress</th>
                    <th class="table-danger">CriticalPort</th>
                    <th class="table-danger">OpenPort</th>
                    <th class="table-danger">WebServer</th>
                    <th class="table-danger Admin-only-Containers d-none ">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model.Where(vm => vm.Round == round && round <= vm.Current_Round))
                {
                    <tr>
                        <td>@item.Id</td>
                        <td>@item.Title</td>
                        <td>@item.Name</td>
                        <td>@item.IpAddress</td>
                        <td>@item.CriticalPort</td>
                        <td>@item.OpenPort</td>
                        <td>@item.WebServer</td>
                        <td class="Admin-only-Containers d-none"><button data-ip="@item.IpAddress" class="btn btn-danger" id="delete-button">X</button></td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@* model start here*@

<div class="modal fade" id="domainModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add Domain</h5>
                <button type="button" class="btn btn-danger close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="domainForm" class="was-validated">
                    <div class="form-group">
                        <label for="Title">Title</label>
                        <input type="text" class="form-control" id="Title" name="Title" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>  
                    <div class="form-group">
                        <label for="Name">Name</label>
                        <input type="text" class="form-control" id="Name" name="Name" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>  
                    <div class="form-group">
                        <label for="IP Address">IP Address</label>
                        <input type="text" class="form-control" id="IpAddress" name="IpAddress" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>  
                    <div class="form-group">
                        <label for="CriticalPort">CriticalPort</label>
                        <input type="text" class="form-control" id="CriticalPort" name="CriticalPort" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="OpenPort">OpenPort</label>
                        <input type="text" class="form-control" id="OpenPort" name="OpenPort" required autocomplete="off">
                         <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="WebServer">WebServer</label>
                        <input type="text" class="form-control" id="WebServer" name="WebServer" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveDomain">Save</button>
            </div>
        </div>
    </div>
</div>




@section Scripts{
    <script>
        $(document).ready(function(){
            var customerId = @Model.Select(vm => vm.Id).First();

             if ('@Context.Request.HttpContext.Session.GetString("UserType")' === 'Customer') {
                $('.Customer-only-Containers').removeClass("d-none");
            } else {
                $('.Admin-only-Containers').removeClass("d-none");
            }

            $("#addDomainButton").click(function () {
                $("#domainModal").modal("show");
            });
            
            $("#delete-button").click(function () {
                var ip = $(this).attr('data-ip');
                alert(ip);
                var data  ={
                customerId,
                 ip
                }
                $.ajax({
                    type: 'Post',
                    url: '/Dashboard/DeleteDomain',
                    data:data,
                    success: function (response) {
                      if(response.status == true){
                         location.reload();
                      }
                      else{
                          console.log(response.message);
                      }
                    },
                    error: function (error) {
                        console.error('Error disabling user: ' + JSON.stringify(error));
                    }
                });
            }); 
            
            $(".close").click(function () {
                $("#domainModal").modal("hide");
            });

            $("#saveDomain").click(function () {
                var domainData = {
                    Id: customerId,
                    Title: $("#Title").val(),
                    Name: $("#Name").val(),
                    IpAddress: $("#IpAddress").val(),
                    CriticalPort: $("#CriticalPort").val(),
                    OpenPort: $("#OpenPort").val(),
                    WebServer: $("#WebServer").val(),
                };
                $.ajax({
                    type: 'POST',
                    url: '/Dashboard/AddDomain',
                    data: domainData,
                    success: function (response) {
                        alert(response.message);
                    },
                    error: function (error) {
                        console.error('Error disabling user: ' + JSON.stringify(error));
                    }
                });
            });
        });
    </script>
}