@model List<LP.Models.ViewModels.DomainVM> 

@{
    ViewData["Title"] = "Domains";
    int tableCounter = 0;
}


<div class="container-md min-vh-100">
    <a class="btn btn-outline-danger border-none mt-4" asp-action="Index" asp-controller="SecurityDashboard">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-house-door-fill" viewBox="0 0 16 16">
            <path d="M6.5 14.5v-3.505c0-.245.25-.495.5-.495h2c.25 0 .5.25.5.5v3.5a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4a.5.5 0 0 0 .5-.5Z" />
        </svg>
    </a>
    <button class="btn btn-danger mt-4 Admin-only-Containers d-none" id="addDomainButton">Add Domain</button>
    <hr />
    @if (Model.Any())
    {
        @foreach (var roundGroup in Model.GroupBy(vm => vm.Round).OrderByDescending(g => g.Key))
        {
            <h2 class="round-header">
                <span class="mx-2 text-uppercase fw-semibold">Round @roundGroup.Key</span>
            </h2>
            <table id="domainTable" class="table my-4 table-bordered table-responsive-md round-table">
                <thead>

                    <tr>
                        @*<th class="table-danger">Customer Id</th> *@
                        <th class="table-danger">Title</th>
                        <th class="table-danger">Name</th>
                        <th class="table-danger">IP Address</th>
                        <th class="table-danger">Critical Port</th>
                        <th class="table-danger">Open Port</th>
                        <th class="table-danger">Web Server</th>
                        <th class="table-danger Admin-only-Containers d-none ">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in roundGroup)
                    {
                        <tr>
                            @*  <td>@(item.Id)</td>  *@            @* ?? null-coalescing  operator*@
                            <td>@(item.Title ?? "N/A")</td>
                            <td>@(item.Name ?? "N/A")</td>
                            <td>@(item.IpAddress ?? "N/A")</td>
                            <td>@(item.CriticalPort ?? "N/A")</td>
                            <td>@(item.OpenPort ?? "N/A")</td>
                            <td class="web-server">@(item.WebServer ?? "N/A")</td>
                            <td class="Admin-only-Containers d-none">
                                <button data-ip="@item.IpAddress" class="btn btn-danger delete-button"> X </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    }
</div>

@* model start here*@

<div class="modal fade" id="domainModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Add Domain</h5>
                <button type="button" class="btn btn-danger close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="domainForm" class="was-validated">
                    <div class="form-group">
                        <label for="Title">Title</label>
                        <input type="text" class="form-control" id="Title" name="Title" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>  
                    <div class="form-group">
                        <label for="Name">Name</label>
                        <input type="text" class="form-control" id="Name" name="Name" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>  
                    <div class="form-group">
                        <label for="IpAddress">IP Address</label>
                        <input type="text" class="form-control" id="IpAddress" name="IpAddress" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>  
                    <div class="form-group">
                        <label for="CriticalPort">CriticalPort</label>
                        <input type="text" class="form-control" id="CriticalPort" name="CriticalPort" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="OpenPort">OpenPort</label>
                        <input type="text" class="form-control" id="OpenPort" name="OpenPort" required autocomplete="off">
                         <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="WebServer">WebServer</label>
                        <input type="text" class="form-control" id="WebServer" name="WebServer" required autocomplete="off">
                        <div class="invalid-feedback">
                            This is required.
                        </div>
                        <div class="valid-feedback">
                            Looks good!
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn close btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveDomain">Save</button>
            </div>
        </div>
    </div>
</div>




@section Scripts{
    <script>
        $(document).ready(function(){
            var customerId = @Convert.ToInt32(Context.Request.HttpContext.Session.GetString("CurrentUser"));
            for (var i = 0; i < @tableCounter; i++) {
                $('#domainTable_' + tableIndex).DataTable({
                    "paging": true,
                    "ordering": true,
                    "searching": true,
                    "info": true,
                    "responsive": true,
                    "lengthMenu": [10, 25, 50, 100],
                    "pageLength": 10
                });
            }

     
            $(".delete-button").on('click',function () {
                var ip = $(this).data('ip');

                var data = {
                    customerId,
                    ip
                }

                $.ajax({
                    type: 'Post',
                    url: '/Dashboard/DeleteDomain',
                    data: data,
                    success: function (response) {
                        if (response != null) {
                            setTimeout(() => {
                                location.reload();
                            },2000)
                        }
                        else {
                            console.log(response.message);
                        }
                    },
                    error: function (error) {
                        console.error('Error disabling user: ' + JSON.stringify(error));
                    }
                });
            });


            if ('@Context.Request.HttpContext.Session.GetString("UserType")' === 'Customer') {
              $('.Customer-only-Containers').removeClass("d-none");
            } 
            else 
            {
                $('.Admin-only-Containers').removeClass("d-none");
            }

            $('.web-server:contains("N/A")').css('color', 'red');


            $("#addDomainButton").click(function () {
                $("#domainModal").modal("show");
            });
            
            $(".close").click(function () {
                $("#domainModal").modal("hide");
            });

            $("#saveDomain").click(function () {
                var domainData = {
                    Id: customerId,
                    Title: $("#Title").val(),
                    Name: $("#Name").val(),
                    IpAddress: $("#IpAddress").val(),
                    CriticalPort: $("#CriticalPort").val(),
                    OpenPort: $("#OpenPort").val(),
                    WebServer: $("#WebServer").val(),
                };
                $.ajax({
                    type: 'POST',
                    url: '/Dashboard/AddDomain',
                    data: domainData,
                    success: function (response) {
                        if (response != null) {
                            $("#domainModal").modal("hide");
                            setTimeout(() => {
                                location.reload();
                            }, 1500)
                        }
                       
                    },
                    error: function (error) {
                        console.error('Error disabling user: ' + JSON.stringify(error));
                    }
                });
            });



            
        });
    </script>
}